(function(n){n.fn.listGroup=function(t){var i=this,u=this.selector,r;return i.searchParams={limit:null},r=n.extend({footer:null,tableSize:null,initCallback:null},t),i.set=r,i.globalTimeout,i.drawItem=function(n,t){var i='<li class="media" dataid="'+n[t.id]+'" data-parent="'+(t.relateId!=null?n[t.relateId]:"")+'"><a href="javascript:void(0)" class="media-link">';return t.left!=null&&(i+=' <div class="media-left">'+t.left.render(n)+"<\/div>"),i+='<div class="media-body">'+t.body.render(n)+"<\/div>",t.right!=null&&(i+=' <div class="media-right">'+t.right.render(n)+"<\/div>"),i+"<\/a><\/li>"},i.loadData=function(t,f,e){var o=r.groups[t],c,l,v,h,s,a,p,y,w;o.list!=null?(i.hideLoading(t),c=n(u).find('.group-item[data-group="'+t+'"]'),l=n(c).find(" ul.media-list"),v=o.list,o.data=v,l.html(""),o.item.default!=null&&(h=i.drawItem(o.item.default,o.item),l.append(h)),n(v).each(function(){h=i.drawItem(this,o.item);l.append(h)}),r.autoLoad&&(o.activeId!=null?(p=l.find('li[dataid="'+o.activeId+'"]'),i.selectItem(p)):i.selectItem(l.find("li:eq(0)"))),i.dataEvents(t)):o.ajax!=null?(y=o.ajax.url,y!=null&&(c=n(u).find(' > .advance-list-group > .group-item[data-group="'+t+'"]'),n(c).find(".search-group input").attr("data-parent",f),n(c).find(".heading-elements .btn-add").attr("data-parent",f),s=o.ajax.data,e!=null&&n.extend(s,e),w=i.getFilterParam(t),n.extend(s,w),o.item.relateId!=null&&(typeof f!="undefined"?(s[o.item.relateId]=f,a={},a[o.item.relateId]=f,o.activeRelateObj=a):typeof o.activeRelateObj!="undefined"&&o.activeRelateObj!=null&&(s[o.item.relateId]=o.activeRelateObj[o.item.relateId])),o.type=="html"&&(s.dataType="html"),i.showLoading(t),app.loadData(y,s,null,function(u){i.hideLoading(t);switch(o.type){case"list":var e=n(c).find(" ul.media-list"),s=u.Many!=null?u.Many:u;o.data=s;e.html("");o.item.default!=null&&(h=i.drawItem(o.item.default,o.item),e.append(h));s.length>0?(n(s).each(function(){h=i.drawItem(this,o.item);e.append(h)}),r.autoLoad&&i.selectItem(e.find("li:eq(0)"))):e.html('<li><div class="alert alert-warning no-border no-margin"> Không tìm thấy kết quả phù hợp <\/div><\/li>');break;case"html":n(c).find(".group-content > .html-content").html(u)}i.dataEvents(t);o.loadDataCallback!=null&&o.loadDataCallback(t,f)}))):o.grid!=null&&(s={},e!=null&&n.extend(s,e),console.log(o.relateId,f),o.relateId!=null&&(s[o.relateId]=f,a={},a[o.relateId]=f,o.grid.searchParams[o.relateId]=f,o.activeRelateObj=a),o.grid.search(s))},i.selectItemById=function(t,r){var o=n(u).find('.group-item[data-group="'+t+'"]'),f=n(o).find(" ul.media-list"),e;f.find("> li.active").removeClass("active");e=f.find('li[dataid="'+r+'"]');i.selectItem(e)},i.selectItem=function(n){n.addClass("active");var f=n.attr("dataid"),t=parseInt(n.closest(".group-item").attr("data-group")),u=r.groups[t];t++;t<r.groups.length&&i.loadData(t,f);u!=null&&u.selectCallback!=null&&u.selectCallback(f)},i.getDataById=function(t,i){var u,f=r.groups[t];return n(f.data).each(function(){if(this.Id==i){u=this;return}}),u},i.dataEvents=function(t){var f=n(u).find(' > .advance-list-group > .group-item[data-group="'+t+'"]'),e,o;n(f).find("ul li.media a").unbind().click(function(){var t=n(this).closest("ul");t.find("> li").removeClass("active");i.selectItem(n(this).closest("li"))});e=r.groups[t];e.contextMenu!=null&&(o=f.find("> .context-menu-popup"),f.find("ul.media-list > li").unbind().contextmenu({target:o.selector,before:function(r,u){r.preventDefault();var o=this.getMenu(),s=n(u).attr("dataid"),f=i.getDataById(t,s);return n(e.contextMenu).each(function(){var n=o.find("a."+this.class).closest("li"),t;this.enable==null||this.enable(f)?(n.css("display","block"),this.visible==null||this.visible(f)?this=="edit"||this=="delete"?(t=o.find('a[action="edit"], a[action="delete"]'),f.Status!=null&&f.Status>0?t.addClass("disabled"):t.removeClass("disabled")):n.find("a").removeClass("disabled"):n.find("a").addClass("disabled")):n.css("display","none")}),!0},onItem:function(r,u){var f=n(u.currentTarget);f.hasClass("dropdown-submenu")||n(u.target).hasClass("disabled")||i.clickContextMenu(t,r,u)}}))},i.showLoading=function(t){var i=n(u).find(' > .advance-list-group > .group-item[data-group="'+t+'"]');i.find(".loading").show()},i.hideLoading=function(t){var i=n(u).find(' > .advance-list-group > .group-item[data-group="'+t+'"]');i.find(".loading").hide()},i.createOrUpdateObject=function(t,u,f){var o;i.showLoading(t);var s=r.groups[t],e=s.command,h=e.editController!=null?e.editController+"/":"/admin/";h+=e.model+"Edit";n.extend(f,e.param);o=app.newGuid();app.createPartialModal({url:h,data:f,modal:{title:(u==1?"Cập nhật ":"Thêm mới ")+s.header.title.toLowerCase(),id:o,width:e.modal.width,model:e.model}},function(){i.hideLoading(t);e.loadModalCallback!=null&&e.loadModalCallback(t,o)})},i.deleteObjects=function(t,i,f,e){var s=r.groups[t],o=s.command;app.confirm("warning",null,f.length+" đối tượng được chọn để xóa.",function(){var t=o.editController!=null?o.editController+"/":"/admin/";i=="bulk"?app.postData(t+"/delete"+o.model+"ByIds",{ids:f},function(){e!=null&&e()}):n.ajax({url:t+"/delete"+r.model,type:"POST",data:{model:r.model,id:f[0]},success:function(){typeof webaby!="undefined"&&webaby.hideModalLoading();n("#deleteModal").modal("hide");e!=null&&e()}});n(u).find(".checkAll").prop("checked",!1);n.uniform.update()})},i.clickContextMenu=function(t,u,f){var o=n(f.target),y,h,e,c,l;o[0].hasAttribute("action")||(o=n(f.target).closest("a"));var s=n(u.context),p=o.attr("action"),a=o.attr("class"),v=r.groups[t];switch(p){case"edit":i.createOrUpdateObject(t,1,{id:n(s).attr("dataid")},function(){});break;case"delete":y=n(s).attr("dataid");i.deleteObjects(t,"bulk",[y],function(){i.loadData(t)});break;case"custom":for(h=0;h<v.contextMenu.length;h++)if(e=v.contextMenu[h],a==e.class){if(e.click!=null)return e.click(s),!1}else if(e.childs!=null)for(c=0;c<e.childs.length;c++)if(l=e.childs[c],a==l.class&&l.click!=null)return l.click(s),!1}},i.resetSlimScroll=function(t,i,r){n(t).find(" > .slimScrollDiv").css("width",i).css("height",r);n(t).find(" > .slimScrollDiv > .scroller").css("width",i).css("height",r)},i.resize=function(){var f=n(window).height(),s=n(u).width(),t,o,h=n(u).find(".advance-list-group"),e=0;r.top!=null&&(f-=r.top);n(u).find("> .advance-list-group").css("height",f);n(r.groups).each(function(r,h){var c=f,l;h.header!=null&&(c=f-43,(h.header.filter!=null||h.header.toolbar!=null)&&(c=f-94));h.width.indexOf("px")>0?t=parseInt(h.width.substr(0,h.width.length-2)):h.width.indexOf("%")>0?(o=parseInt(h.width.substr(0,h.width.length-1)),t=s*o/100):t=s-e;l=n(u).find(' > .advance-list-group > .group-item[data-group="'+r+'"]');n(l).css("width",t).css("left",e);h.grid!=null?(n(l).find(".apply-advance-grid").css("height",c),n(l).find(".apply-level-grid").css("height",c)):i.resetSlimScroll(l,t,c);h.width.indexOf("px")>0?e+=parseInt(h.width.substr(0,h.width.length-2)):h.width.indexOf("%")>0&&(o=parseInt(h.width.substr(0,h.width.length-1)),e+=t)})},i.loadFilterOption=function(t,i){var f,u,e;if(!n(t).hasClass("loaded")&&(f=t.attr("data-index"),u=r.rows[f].filter,u.ajax!=null))return e=u.ajax.data,app.loadData(u.ajax.url,e,null,function(r){t.addClass("loaded");var f=r.Many!=null?r.Many:r;n(f).each(function(){var n=new Option(this[u.ajax.attr.text],this[u.ajax.attr.id],!0,!0);t.append(n)});t.select2("val","");i!=null&&i()}),!0},i.getFilterParam=function(t){var f=n(u).find(' > .advance-list-group > .group-item[data-group="'+t+'"]'),e,i;return r.groups[t].header!=null?(e=r.groups[t].header.filter,i={},n(e).each(function(){var t,r;switch(this.type){case"month":t=n(f).find('.search-group input[data-attr="'+this.attr+'"]');i[this.attr]=t.val();break;case"option":r=n(f).find('.search-group select[data-attr="'+this.attr+'"]');i[this.attr]=r.val()}}),i):null},i.staticEvents=function(){var t=n(u).find("> .advance-list-group").height();n(r.groups).each(function(f,e){var s=e.header!=null?t-100:t,o=n(u).find(' > .advance-list-group > .group-item[data-group="'+f+'"]');n(o).find(".scroller").slimScroll({height:s+"px",size:"8px"});switch(e.type){case"grid":e.grid=n("#"+e.gridId).advanceGrid(e.option);break;case"levelGrid":e.grid=n("#"+e.gridId).levelGrid(e.option)}n(o).find(".btn-add").click(function(){var u=n(this).attr("data-parent"),e=n(this).closest(".group-item").attr("data-group"),o=r.groups[parseInt(e)],t={};t[o.item.relateId]=u;i.createOrUpdateObject(f,0,t,function(){})})});i.resize();n(u).find(".search-group input").unbind().keyup(function(){var r=parseInt(n(this).closest(".group-item").attr("data-group")),u=n(this).attr("data-attr"),f=n(this).attr("data-parent"),e=n(this).val(),t;i.globalTimeout!=null&&clearTimeout(i.globalTimeout);t={};t[u]=e;i.globalTimeout=setTimeout(function(){i.loadData(r,f,t);clearTimeout(i.globalTimeout)},400)});n(u).find(".search-group .select-option").unbind().select2({minimumResultsForSearch:1,dropdownCssClass:"bigdrop"}).on("select2-open",function(){var t=n(this);i.loadFilterOption(t,function(){return t.select2("close").select2("open"),!0})}).on("change",function(t){var r=n(t.target),f=n(r).attr("data-attr"),e=parseInt(n(r).closest(".group-item").attr("data-group")),o=n(r).attr("data-parent"),u={};u[f]=t.val;i.loadData(e,o,u)});n(u).find(".search-group .datepicker").each(function(){var t=n(this).attr("name");n(u).find('.search-group div[name="'+t+'"]').compoDate({placeHolder:"Tất cả",selectCallback:function(t,r){var f=n(r).attr("data-attr"),e=parseInt(n(r).closest(".group-item").attr("data-group")),o=n(r).attr("data-parent"),u={};u[f+"From"]=t.from!=null?app.convertVnToEnDate(t.from):null;u[f+"To"]=t.to!=null?app.convertVnToEnDate(t.to):null;i.loadData(e,o,u)}})});n(u).find(".search-group .datetime-month").each(function(){var t=n(this).attr("name");n(u).find('.search-group input[name="'+t+'"]').datetimepicker({viewMode:"months",format:"MM/YYYY",locale:"vi"}).on("dp.change",function(t){var r=t.currentTarget,f=n(t.currentTarget).attr("data-attr"),e=parseInt(n(r).closest(".group-item").attr("data-group")),o=n(r).attr("data-parent"),u={};u[f]=t.date.format("MM/YYYY");i.loadData(e,o,u)})});n(window).resize(function(){i.resize()});r.initCallback!=null&&r.initCallback()},i.init=function(){var o=n(u).width(),s,t,e,h,f;n(u).append('<div class="advance-list-group"><\/div>');h=n(u).find(" > .advance-list-group");f=0;n(r.groups).each(function(i,r){var w,u,p,c,v,b,y,l,a;if(r.width.indexOf("px")>0?t=parseInt(r.width.substr(0,r.width.length-2)):r.width.indexOf("%")>0?(e=parseInt(r.width.substr(0,r.width.length-1)),t=o*e/100):t=o-f,w="left: "+f+"px; width: "+t+"px",u='<div class="group-item" data-type="'+r.type+'" data-group="'+i+'" style="'+w+'">',r.header!=null){if(u+='<div class="group-header"><h6 class="text-bold">'+r.header.title+"<\/h6>",r.header.filter!=null){for(u+='<div class="search-group">',p=0;p<r.header.filter.length;p++){c=r.header.filter[p];v=c.width!=null?c.width:"100%";switch(c.type){case"contains":u+='<div class="form-group has-feedback" style="width: '+v+'"><div class="form-control-feedback"><i class="icon-search4 text-muted"><\/i><\/div><input type="text" class="form-control"  data-attr="'+c.attr+'" data-index="'+i+'" placeholder="Tìm '+r.header.title.toLowerCase()+'" ><\/div>';break;case"option":u+='<div class="form-group form-group-sm"  style="width: '+v+'"><div class="input-group input-group-sm"><div class="input-group-btn" > <button type="button" class="btn btn-default btn-left dropdown-toggle" title="" data-toggle="dropdown"><i class="icon-filter4"><\/i><\/button><\/div><select class="form-control filter-option select-option loaded" data-attr="'+c.attr+'"  data-index="'+i+'" data-width="'+s+'">';c.placeHolder!=!1&&(u+='<option value="">Tất cả<\/option>');c.lst!=null&&(b=c.lst(),n(b).each(function(){u+='<option value="'+this.id+'">'+this.text+"<\/option>"}));u+="<\/select><\/div><\/div>";break;case"optionRemote":u+='<div class="form-group form-group-sm"  style="width: '+v+'"><div class="input-group input-group-sm"><div class="input-group-btn" > <button type="button" class="btn btn-default btn-left dropdown-toggle" title="Lộc dữ liệu" data-toggle="dropdown"><i class="icon-filter4"><\/i><\/button><\/div><input type="text" data-attr="'+c.attr+'" class="form-control filter-option select-option-remote" data-index="'+i+'" data-width="'+s+'"/>';u+="<\/div><\/div>";break;case"compoTree":u+='<div class="form-group form-group-sm"  style="width: '+v+'"><div class="input-group input-group-sm"><div class="input-group-btn" > <button type="button" class="btn btn-default btn-left dropdown-toggle" title="Lộc dữ liệu" data-toggle="dropdown"><i class="icon-filter4"><\/i><\/button><\/div>';u+='<input class="form-control compo-tree" id="'+app.newGuid()+'" data-index="'+i+'"  data-attr="'+c.attr+'" type="text" />';u+="<\/div><\/div>";break;case"compoMoney":u+='<div class="compo-money" from to name=""  style="width: '+v+'"  data-attr="'+c.attr+'"><\/div>';break;case"number":u+='<div class="compo-number" from to name="  style="width: '+v+'""  data-attr="'+c.attr+'"><\/div>';break;case"date":u+='<div class="form-group form-group-sm"  style="width: '+v+'"><div class="datepicker" from to name="" data-index="'+i+'" data-attr="'+c.attr+'"><\/div><\/div>';break;case"month":u+='<div class="form-group form-group-sm  has-feedback has-feedback-right"  style="width: '+v+'"" ><input class="form-control datetime-month"  data-attr="'+c.attr+'" type="text" name="'+c.attr+'"  placeholder="tháng" value="'+moment().format("MM/YYYY")+'" /> <div class="form-control-feedback"><i class="icon-calendar2"><\/i><\/div><\/div>'}}u+="<\/div>"}r.header.toolbar&&(u+='<div class="search-group">'+r.header.toolbar+"<\/div>");y='<div class="heading-elements"><ul class="icons-list" >';r.header.create&&(y+='<li><button class="btn btn-add btn-icon btn-xs" type="button" title="Thêm mới '+r.header.title.toLowerCase()+'"><i class="icon-plus3"><\/i><\/button>');r.header.sort!=null&&(y+='<li><button class="btn btn-sort btn-icon btn-xs" title="Sắp xếp"><i class="icon-sort-alpha-asc"><\/i><\/button>');y+="<\/ul ><\/div>";u+=y;u+="<\/div>"}switch(r.type){case"list":u+='<div class="group-content scroller '+(r.header!=null?"has-header":"")+'">';u+=app.loading(!0);u+='<ul class="media-list media-list-linked media-list-bordered"><\/ul>';break;case"grid":u+='<div class="apply-advance-grid" style="">';u+='<div class="group-content '+(r.header!=null?"has-header":"")+'" style="width: '+(t-15)+'px">';r.gridId=app.newGuid();u+='<div id="'+r.gridId+'" ><\/div>';u+="<\/div>";break;case"html":u+='<div class="group-content scroller '+(r.header!=null?"has-header":"")+'">';u+=app.loading(!0);u+='<div class="html-content"><\/div>';break;case"levelGrid":u+='<div class="apply-level-grid" style="">';u+='<div class="group-content '+(r.header!=null?"has-header":"")+'" style="width: '+(t-15)+'px">';r.gridId=app.newGuid();u+='<div id="'+r.gridId+'" ><\/div>';u+="<\/div>";break;default:u+='<div class="group-content scroller '+(r.header!=null?"has-header":"")+'">';u+=app.loading(!0)}if(u+="<\/div>",r.contextMenu!=null){for(l='<div class="context-menu-popup"><ul class="dropdown-menu">',i=0;i<r.contextMenu.length;i++){a=r.contextMenu[i];switch(a){case"edit":l+='<li><a href="#" action="edit"><i class="icon-pencil7 position-left"><\/i>Cập nhật<\/a><\/li>';break;case"delete":l+='<li><a href="#" action="delete"><i class="icon-x position-left"><\/i>Xóa<\/a><\/li> ';break;case"-":l+='<li class="divider" ><\/li>';break;case"sort":l+='<li class="divider" ><\/li> <li class="dropdown-header"><i class="icon-sort position-left"><\/i>Di chuyển<\/li><li> <a href="#" action="move-top"><i class="position-left"><\/i>Lên đầu<\/a><\/li> <li> <a href="#" action="move-bottom"><i class="position-left"><\/i>Xuống cuối<\/a><\/li> <li> <a href="#" action="chose-position"><i class="position-left"><\/i>Chọn vị trí<\/a><\/li> <li> <a href="#" class="disabled near" action="near-above"><i class="position-left"><\/i>Liền trên<\/a><\/li> <li> <a href="#" class="disabled near" action="near-under"><i class="position-left"><\/i>Liền dưới<\/a><\/li> ';break;default:a.childs!=null?(l+='<li class="dropdown-submenu dropdown-submenu-hover">',l+='<a href="#"><i class="'+a.icon+' position-left" ><\/i>'+a.text+"<\/a>",l+='<ul class="dropdown-menu">',n.each(a.childs,function(){l+='<li> <a href="#"  action="custom" class="'+this.class+'">'+this.text+"<\/a><\/li> "}),l+="<\/ul>",l+="<\/li>"):l+='<li><a href="#" title="'+a.text+'" action="custom" class="'+a.class+'">'+(a.icon!=null?'<i class="'+a.icon+'"><\/i>':"")+a.text+"<\/a><\/li> "}}l+="<\/ul><\/div>";u+=l}u+="<\/div>";h.append(u);r.width.indexOf("px")>0?f+=parseInt(r.width.substr(0,r.width.length-2)):r.width.indexOf("%")>0&&(e=parseInt(r.width.substr(0,r.width.length-1)),f+=t)});i.staticEvents();r.autoLoad&&i.loadData(0)},i.init(),this}})(jQuery)