(function(n){n.fn.webabyTree=function(t){function a(){n(u).find(".webaby-tree .wtree-anchor").mouseover(function(){n(this).parent().children(".wtree-wholerow").addClass("wholerow-hovered")}).mouseout(function(){n(this).parent().children(".wtree-wholerow").removeClass("wholerow-hovered")})}function v(n){var t='<li data-bind="css:{ open : opened() }, attr:{ level: level, id: id },"><div class="wtree-wholerow" data-bind="click: $root.open"><\/div>';return t+="      <i class=\"wtree-icon wtree-ocl fa\" data-bind=\"click: $root.open, css: { 'fa-angle-down' : opened(), 'fa-angle-right' : !opened(), empty : childs().length == 0 }\"><\/i>",n.mode=="checkbox"?(t+='      <a href="#" class="wtree-anchor">',t+="          <i class=\"wtree-icon wtree-checkbox\" data-bind=\"click: $root.select, css:{ 'icon-checkbox-checked2' : selected(), 'icon-checkbox-unchecked2' : selected() == false }\"><\/i>"):t+=n.mode=="link"?'      <a data-bind="attr:{ href: code}, css: { active: opened() == true }" class="wtree-anchor hoverable">':'      <a href="#" data-bind="css: { active : selected() == true }, click: $root.select" class="wtree-anchor hoverable">',n.icon!=null&&(t+="          <i class=\"wtree-icon fa \" data-bind=\" css:{ 'fa-folder' : !opened() && childs().length > 0, 'fa-folder-open' : opened() && childs().length > 0, 'fa-file-text-o' : childs().length == 0 }, click: $root.open \"><\/i>"),t+='          <span data-bind="text: name ',n.mode=="checkbox"&&(t+=", click: $root.open"),t+='"><\/span>',t+="      <\/a>",t+'      <ul class="wtree-children" data-bind="fadeVisible: opened(), foreach: childs ">'}function l(t,i,u){var e;return n.each(i,function(n,o){var a=o;if(a[r.parent]==t.id){var h=u+1,v=new s(a,h),c=l(v,i,h);t.childs.push(v);e=h;c>0&&c>f&&(f=c)}}),e}function y(){var t='<div class="wtree-content">';t+='<input type="hidden" id="'+i.resultElement+'" name="'+i.resultElement+'" />';t+='<ul class="wtree-children wtree" data-bind="foreach: leads"><\/ul><\/div>';n(u).append(t);h.loadData()}var u=this.selector,h=this,i=n.extend({url:null,model:null,params:{},resultElement:null,rootId:null,item:null,singleNode:null,openAll:null,lead:null,selected:null,notRelated:null,values:null,relateSelection:null,notAutoLoad:null,multiSelection:null,changedCallback:null},t),r={id:"Id",name:"Name",parent:"Parent",code:"Code"},e,f,o,s,c;return i.item!=null&&(r=i.item),f=0,o=[],i.values!=null&&(o=i.values.split(";").map(Number)),s=function(t,u){var f=this;f.data=t;f.id=t[r.id];f.name=t[r.name];f.parent=t[r.parent];f.level=u;f.mode=ko.observable(t.mode);f.code="/"+t[r.code];n.inArray(parseInt(t[r.id]),o)>=0?(f.selected=ko.observable(!0),f.opened=ko.observable(!0)):(f.selected=ko.observable(!1),f.opened=i.openAll!=null&&i.openAll?ko.observable(!0):ko.observable(!1));f.childs=ko.observableArray([])},c=function(){var t=this;t.leads=ko.observableArray([]);t.ids=[];t.idExist=function(n){for(var i=0;i<t.ids.length;i++)if(t.ids[i]==n)return!0;return!1};t.open=function(r){i.lead.mode=="select"&&n.each(t.leads(),function(n,i){i.selected(!1);t.selectChilds(i)});r.opened()?r.opened(!1):r.opened(!0)};t.selectParents=function(i,r){n.each(i,function(n,i){if(i.id==r.parent)if(i.selected(r.selected()),r.selected()?t.idExist(i.id)||t.ids.push(i.id):jQuery.grep(t.ids,function(n){return n!=i.id}),i.parent!=null)t.selectParents(t.leads(),i);else return!1;else i.level+1<r.level&&t.selectParents(i.childs(),r)})};t.selectChilds=function(i){i.childs().length>0&&n.each(i.childs(),function(n,r){r.selected()!=i.selected()&&(r.selected(i.selected()),t.selectChilds(r))})};t.select=function(r){var f=r.selected();i.multiSelection||(n.each(t.leads(),function(n,i){i.selected(!1);t.selectChilds(i)}),t.ids=[]);f?r.selected(!1):r.selected(!0);i.relateSelection&&(t.selectChilds(r),t.selectParents(t.leads(),r));r.selected()&&(t.idExist(r.id)||t.ids.push(r.id));t.ids.sort(function(n,t){return n-t});n(u).find("#"+i.resultElement).val(t.ids.join(";"));i.changedCallback!=null&&i.changedCallback(t.ids,r)};t.init=function(){if(i.values!=null){var r=i.values;r[0]==";"&&(r=r.substring(1));r[r.length-1]==";"&&(r=r.substring(0,r.length-1));t.ids=r.split(";");n(u).find("#"+i.resultElement).val(t.ids.join(";"))}};t.init()},h.loadData=function(t){var o=i.params;t!=null&&n.extend(o,t);n.ajax({url:i.url,type:"GET",data:o,dataType:"JSON",contentType:"application/json; charset=utf-8",success:function(t){var o,h,y,p,w;if(o=t.Many!=null?t.Many:t,ko.cleanNode(n(u)[0]),n(u).find(".wtree").html(""),o.length>0){for(f=1,h=[],n.each(o,function(n,t){var i=t,u,e;(i[r.parent]==null||i[r.parent]=="")&&(u=new s(i,1),e=l(u,o,1),h.push(u),e>f&&(f=e))}),y="",p="",w=0;w<f;w++)y+=v(i.lead),p+="<\/ul><\/li>";n(u).find(".wtree").append(y+p);e=new c;ko.applyBindings(e,n(u)[0]);n.each(h,function(n,t){e.leads.push(t)});a()}}})},y(),this}})(jQuery);ko.bindingHandlers.fadeVisible={init:function(n,t){var i=t();$(n).toggle(ko.unwrap(i))},update:function(n,t){var i=t();ko.unwrap(i)?$(n).fadeIn():$(n).fadeOut()}}