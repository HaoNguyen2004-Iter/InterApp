(function(n){n.fn.signSignature=function(t){var r=this,u=this.selector,i;return r.searchParams={keyword:"",page:1,limit:null},i=n.extend({url:"",data:null,img:null,signed:null,form:null,allowUpdate:null,signedDate:null,callback:null,before:null,after:null,requesterId:null},t),r.set=i,r.getSignData=function(t){var r;return r=i.before!=null?i.before(i,t):i.state,r!=null&&(r.requesterId=i.requesterId,i.data!=null&&n.extend(r,i.data),r.ObjApprover!=null&&(r.ObjApprover=null)),r},r.updateSigned=function(t){var f=n(u).find(".sign-signature"),r,e;f.html("");r='<div class="signature">';app.hasValue(i.img)?r+='<img style="max-height: 90px" src="'+i.img+'" />':i.allowUpdate?(e=typeof PORTAL_API!="undefined"?PORTAL_API:"",r+='<div class="alert alert-warning no-border">Anh/Chị chưa có chữ ký scan. <a target="_blank" href="'+e+'/employee/edit?tab=signature" style="">Cập nhật chữ ký<\/a><\/div>'):r+='<div class="p-20" style="background: #f5f5f5; width: 120px; margin: auto"><i class="icon-quill2 icon-3x" style="color: #dfdfdf"><\/i><\/div>';r+="<\/div>";f.append(r);i.state.ObjApprover!=null&&f.append('<p  class="mt-15 text-bold no-margin-bottom">'+i.state.ObjApprover.FullName+"<\/p>");f.append('<p style="margin-top: 5px; margin-bottom: 0">Ngày: '+t+"<\/p>")},r.updateUnapprove=function(t){var r=n(u).find(".sign-signature"),f;r.html("");f=n('<div class="signature"><\/div>');f.append('<div class="alert alert-danger alert-bordered"><span class="text-semibold">Không đồng ý duyệt !<\/span> Vì lý do: '+t.LyDoKhongDuyet+"<\/div > ");r.append(f);console.log(i.state.ObjApprover);i.state.ObjApprover!=null&&r.append('<p  class="mt-15 text-bold no-margin-bottom">'+i.state.ObjApprover.FullName+"<\/p>");r.append('<p style="margin-top: 5px">Ngày: '+app.formatDate(t.ApproveDate)+"<\/p>")},r.events=function(){n(u).find(".btn-sign").unbind().click(function(){var t=n(this),u=r.getSignData();u!=null&&(t.button("loading"),app.postData(i.url,u,function(u){t.button("reset");n.isArray(u)?(r.showMessages(u),r.updateSigned(moment().format("DD/MM/YYYY"))):u.Success?r.updateSigned(moment().format("DD/MM/YYYY")):app.notify("warning",u.Message);i.after!=null&&i.after(u.Data)}))});n(u).find(".btn-approve").unbind().click(function(){var t=n(this),f=r.getSignData(t);f!=null&&app.confirm("warning",null,null,function(){t.button("loading");n(u).find(".btn-unapprove").prop("disabled",!0);f.Status=2;app.postData(i.url,f,function(u){t.button("reset");n.isArray(u)?(r.showMessages(u),r.updateSigned(moment().format("DD/MM/YYYY"))):u.Success?r.updateSigned(moment().format("DD/MM/YYYY")):app.notify("warning",u.Message);i.after!=null&&i.after(u.Data)})})});n(u).find(".btn-unapprove").unbind().click(function(){var f=n(this),t=r.getSignData(f),u;t!=null&&(u=app.newGuid(10),swal({title:"Không đồng ý duyệt",text:'<p>Anh/Chị vui lòng cho biết lý do không đồng ý duyệt<\/p><textarea id="confirm_'+u+'" class="form-control" placeHolder="Lý do không đồng ý duyệt"><\/textarea>',html:!0,showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:"#ff5722",cancelButtonText:"Để sau",confirmButtonText:"Hoàn tất",showLoaderOnConfirm:!0},function(){var e=n("#confirm_"+u).val();if(e==="")return swal.showInputError("Anh/Chị vui lòng nhập lý do không đồng ý duyệt !"),!1;t.LyDoKhongDuyet=e;t.Status=3;app.postData(i.url,t,function(t){swal.close();f.button("reset");r.updateUnapprove(t);n.isArray(t)?(r.showMessages(t),r.updateSigned(moment().format("DD/MM/YYYY"))):t.Success?r.updateSigned(moment().format("DD/MM/YYYY")):app.notify("warning",t.Message);i.after!=null&&i.after(t.Data)})}))})},r.showMessages=function(t){var i="signature_message_modal",r;n("#"+i).length==0&&(r='<div class="modal fade" id="signature_message_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"><div class="modal-dialog" role="document"><div class="modal-content"> <div class="modal-body"><\/div><div class="modal-footer text-center"><button type="button" class="btn btn-default" style="margin: auto" data-dismiss="modal">Đóng<\/button> <\/div><\/div><\/div><\/div>',n("body").append(r));n("#"+i+" .modal-body").html("");n(t).each(function(){this.Success?n("#"+i+" .modal-body").append('<div class="alert bg-success alert-styled-left"> '+this.Message+"<\/div>"):n("#"+i+" .modal-body").append('<div class="alert bg-warning alert-styled-left"> '+this.Message+"<\/div>")});n("#"+i).modal("show")},r.init=function(){var t=n('<div class="sign-signature"><\/div>'),f,e,o;if(n(u).append(t),f=i.state,console.log(f),i.mode==1)f.Status>0?r.updateSigned(app.formatDate(f.ApproveDate)):(o=i.allowSign||i.allowSign==null,o?t.append('<button type="button" style="min-width: 150px" data-loading-text="<i class=\'icon-spinner4 fa-spin position-left\'><\/i>Ký tên" class="btn btn-primary btn-sm btn-rounded btn-sign"><i class="icon-quill4 position-left"><\/i>Ký tên<\/button'):(e=i.waitSign||i.waitSign==null,e?t.append('<span class="label label-default">Đang chờ ký tên<\/span><p class="mt-15 text-bold no-margin-bottom">'+(i.state.ObjApprover!=null?i.state.ObjApprover.FullName:"")+"<\/p>"):t.append('<p style="margin-top: 100px; margin-bottom: 20px !important" class="text-bold no-margin-bottom">'+(i.state.ObjApprover!=null?i.state.ObjApprover.FullName:"")+"<\/p>")));else switch(f.Status){case 0:t.append('<span class="label label-default">Đang chờ duyệt<\/span>');break;case 1:i.allowSign?(t.append('<button type="button" data-loading-text="<i class=\'icon-spinner4 fa-spin position-left\'><\/i>Duyệt" class="btn mb-10 btn-success btn-sm  btn-rounded btn-approve"><i class="icon-checkmark3 position-left"><\/i>Duyệt<\/button'),t.append('<button type="button" data-loading-text="<i class=\'icon-spinner4 fa-spin position-left\'><\/i>Không duyệt" class="btn mb-10 btn-sm btn-warning btn-rounded btn-unapprove ml-10"><i class="icon-blocked position-left"><\/i>Không duyệt<\/button')):(e=i.waitSign||i.waitSign==null,e&&t.append('<span class="label label-default">Đang chờ duyệt<\/span>'));break;case 2:r.updateSigned(app.formatDate(f.ApproveDate));break;case 3:r.updateUnapprove(f)}r.events()},r.init(),this}})(jQuery)