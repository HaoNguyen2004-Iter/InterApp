(function(n){n.fn.importer=function(t){var i=this,f=this.selector,r=n.extend({template:null,url:"",callback:null,limit:1,params:null,beforeImport:null,checkDateFormat:!0},t),u,e;return i.set=r,i.fid=app.newGuid(20),i.vm=null,i.limit=r.limit,u=function(t){var u=this;u.status=ko.observable(0);u.icon=ko.computed(function(){switch(u.status()){case 1:return"icon-spinner10 spinner text-muted";case 2:return"icon-checkmark4 text-success";case 3:return"icon-warning22 text-warning"}return""});u.text=t.text;u.step=t.step;u.done=!1;u.percent=ko.observable(0);u.callback=null;u.loop=function(t,f){var o=t.Total,s=!1,h=o%i.limit==0?parseInt(o/i.limit):parseInt(o/i.limit)+1,e=0,c=setInterval(function(){e<h?s||(s=!0,t.page=e,t.limit=i.limit,app.postData(r.url,t,function(t){(u.step==2||u.step==3)&&t.Errors.length>0&&n(t.Errors).each(function(){i.vm.errors.push({row:this.Row,error:this.Error,message:this.Message})});s=!1;e++;u.percent(Math.floor(e/h*100))})):(clearInterval(c),u.step>1?u.status(i.vm.errors().length==0?2:3):u.status(2),f({Step:t.step}))},100)};u.start=function(n,t){u.status(1);n.step=u.step;u.callback=t;switch(u.step){case 1:app.postData(r.url,n,function(n){u.percent(100);u.status(2);u.callback(n)});break;case 2:i.vm.currentStep(2);i.vm.errors.removeAll();u.loop(n,function(n){u.callback(n)});break;case 3:i.vm.currentStep(3);i.vm.errors.removeAll();u.loop(n,function(n){u.callback(n)})}}},e=function(){var t=this;t.steps=ko.observableArray([]);t.currentStep=ko.observable(0);t.errors=ko.observableArray([]);t.checking=!1;t.started=ko.observable(!1);t.done=ko.observable(!1);t.hasError=ko.observable(!1);t.checkNumber=0;t.data=null;t.start=function(i,r){t.data=i;t.started(!0);var u=setInterval(function(){t.checking||(t.checking=!0,n.each(t.steps(),function(n,f){if(f.status()==0)return f.start(i,function(n){if(t.checkNumber++,t.checking=!1,n!=null)switch(n.Step){case 1:t.data.Total=n.Total;t.data.File=n.Path;break;case 2:t.errors().length>0&&(clearInterval(u),t.hasError(!0),r());break;case 3:t.errors().length>0&&(clearInterval(u),t.hasError(!0),t.done(!0),r())}}),!1}));t.checkNumber==t.steps().length&&(clearInterval(u),r())},100)};t.init=function(){t.steps.push(new u({step:1,text:"Đang xử lý file import"}));t.steps.push(new u({step:2,text:"Đang kiểm tra nội dung file"}));t.steps.push(new u({step:3,text:"Đang import nội dung"}))};t.init()},i.events=function(){var t=[{name:"File",type:"file",acceptFormats:["xls","xlsx"],option:{uploadFirst:!0},required:{message:"Chọn file"}}];r.checkDateFormat&&t.push({name:"DateFormat",type:"select2",option:{},required:{message:"Chọn định dạng ngày"}});n("#"+i.fid).ultraForm({uiType:1,action:"/",actionType:"ajax",autoSubmit:!1,props:t,validCallback:function(t,u){t=app.formDataToJson(t);t=n.extend(t,r.params);r.beforeImport!=null&&(t=r.beforeImport(t));u.button("loading");i.vm.start(t,function(){u.button("reset");i.vm.hasError()||(app.notify("success","Quá trình import thành công"),setTimeout(function(){r.callback()},500))})},afterSubmit:function(n){n.Success?callback(n.Data):app.notify("warning",n.Message)}});n("#"+i.fid).find(".btn-continute").click(function(){var t=n(this);t.button("loading");i.vm.start(i.vm.data,function(){t.button("reset");app.notify("success","Quá trình import thành công");setTimeout(function(){r.callback()},500)})});n("#"+i.fid).find(".btn-cancel").click(function(){r.callback()});i.vm=new e;ko.applyBindings(i.vm,n(f)[0])},i.init=function(){var t='<form id="'+i.fid+'" class="form form-horizontal"><div class="p-15"><div class="form-group form-group-sm"><label class="control-label col-md-3">Chọn file import <span class="text-danger">(*)<\/span><\/label><div class="col-md-9"><input name="FilePostFileBase" type="file"><input value="" name="FileUploaded" type="hidden"><input value="" name="File" type="hidden"><\/div><\/div><div class="form-group form-group-sm"><label class="control-label col-md-3">File mẫu<\/label><div class="col-md-9"><a class="" href="'+r.template+'" target="_blank"><i class="icon-file-excel position-left text-success"><\/i> Tải file mẫu<\/a><\/div><\/div>';r.checkDateFormat&&(t+='<div class="form-group form-group-sm"><label class="control-label col-md-3">Định dạng ngày <span class="text-danger">(*)<\/span><\/label><div class="col-md-6"><select class="form-control" name="DateFormat"><option value="">Chọn định dạng ngày<\/option><option value="0">MM/DD/YYYY<\/option><option value="1">DD/MM/YYYY<\/option><\/select><\/div><div class="col-md-3"><\/div><\/div>');t+='<div data-bind="visible: started() == true, foreach: steps"><div class="media no-margin stack-media-on-mobile mb-15"><div class="media-left media-middle"><i class="no-edge-top" style="font-size: 21px; width: 25px; display: block" data-bind="css: icon"><\/i><\/div><div class="media-body"><h6 style = "width: 100%" class="mb-5" > <span class="text-bold" data-bind="text: text"><\/span> <span class="pull-right" data-bind="text: percent() + \'%\'" ><\/span> <\/h6> <div class="progress progress-xxs"> <div class="progress-bar progress-bar-primary"style = "width: 0%" data-bind="style: { \'width\' : percent() + \'%\'}"> <span class="sr-only" > 50 % Complete<\/span> <\/div><\/div> <\/div> <\/div> <table class="table table-bordered table-sm" data-bind="visible: step == $root.currentStep() && $root.errors().length > 0"><thead><tr><th class="text-center" style="width: 50px">Dòng<\/th><th class="text-center text-danger">Lỗi<\/th><\/tr><\/thead><tbody data-bind="foreach: $root.errors"><tr><td data-bind="text: row" class="text-center"><\/td><td data-bind="html: message" class="text-danger"><\/td><\/tbody><\/table><\/div><\/div><\/div><div class="panel-footer panel-footer p-15 text-center"><button class="btn btn-sm btn-fill btn-primary m-r-5 btn-submit btn-rounded" type="button" data-bind="visible: hasError() == false" data-loading-text="<i class=\'icon-spinner4 fa-spin\'><\/i> Import" > <i class="icon-import position-left"><\/i> Import<\/button><button class="btn btn-sm btn-fill btn-default  btn-cancel btn-rounded" type="button" data-bind="visible: hasError() == true"> <i class="icon-x position-left"><\/i> Đóng<\/button><button class="btn btn-sm btn-fill btn-warning ml-15 btn-continute btn-rounded" type="button" data-bind="visible: hasError() == true && done() == false" data-loading-text="<i class=\'icon-spinner4 fa-spin\'><\/i> Tiếp tục import (bỏ qua dòng bị lỗi)" > <i class="icon-import position-left"><\/i> Tiếp tục import (bỏ qua dòng bị lỗi)<\/button><\/div><\/form>';n(f).append(t);i.events()},i.init(),this}})(jQuery)