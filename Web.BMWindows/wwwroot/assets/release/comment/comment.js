(function(n){n.fn.focusTextToEnd=function(){this.focus();var n=this.val();return this.val("").val(n),this}})(jQuery),function(n){n.fn.maxcomment=function(t){var r=this.selector,u=this,i=n.extend({url:null,type:null,objectId:null,hasCount:!0,userId:null,limit:null},t),e={objectId:i.objectId,type:i.type,hasCount:!0,parentId:0,limit:i.limit!=null?i.limit:10},o;u.comFormEvents=function(t,u,f){n("#"+t+" textarea").unbind().focus(function(){if(!app.hasValue(i.userId))return window.location.href=idDomain+"/auth/login?returnurl="+n(location).attr("href")+r,null;n("#"+t+" .btn-sent").css("display")=="none"&&n("#"+t+" .btn-sent").css("display","inline");n("#"+t).hasClass("com-form-top")&&n(r).find(".reply-form-render").html("")});n("#"+t+" textarea").keyup(function(){var i=n(this).val();app.hasValue(i)?n("#"+t+" .btn-sent").prop("disabled",!1):n("#"+t+" .btn-sent").prop("disabled",!0)});n("#"+t+" .btn-sent").unbind().click(function(){var r=n(this),e;r.button("loading");e={hDetail:n("#"+t+" textarea").val(),parentId:u,type:i.type,objectId:i.objectId};n("#"+t+" .media-body").addClass("disabled");n("#"+t+" textarea").prop("disabled",!0);postData("/api/createComment",e,function(i){r.button("reset");n("#"+t+" textarea").prop("disabled",!1);n("#"+t+" .media-body").removeClass("disabled");n("#"+t+" .btn-sent").css("display","none");f(i)})});n("#"+t+" .btn-cancel").unbind().click(function(){n("#"+t).remove()});app.lazyLoader()};u.drawComForm=function(n,t,r){var f=app.newGuid(),u='<div class="comment-form" id="'+f+'"><div class="media"><div class="media-left">';u+=app.hasValue(i.userId)?'<img class="img-circle img-sm lazy" data-src="'+staticDomain+app.idImage("agents",0,i.userId,null,"avatar")+'" />':'<img class="img-circle img-sm lazy" data-src="'+staticDomain+'/media/default/agents/default-user.png" />';u+='<\/div><div class="media-body"><div class="com-box"><div class="arrow-inner"><\/div><div class="arrow-outer"><\/div><textarea class="form-control '+(app.hasValue(i.userId)?"":"pointer")+'" rows="2" placeholder="Mời bạn để lại bình luận">'+t+'<\/textarea><\/div><div class="text-right mt-10"><button type="button" class="btn btn-sm btn-default btn-cancel mr-10">Thoát<\/button><button type="button" disabled="disabled" class="btn btn-sm btn-primary btn-sent"  data-loading-text="<i class=\'icon-spinner10 spinner position-left\'><\/i> Đang xử lý">Bình luận<\/button><\/div><\/div><\/div>';n.append(u);r(f)};var f=function(n,t){var r=this,u,f;n!=null?(r.id=ko.observable(n.Id),r.userId=ko.observable(n.UserId),r.userName=ko.observable(n.UserName),r.media=ko.observable(n.UserMedia),r.time=ko.observable(beatyTime(n.CreatedDate)),r.parent=ko.observable(n.ParentId),r.male=ko.observable(n.Male),r.detail=ko.observable(n.Detail),r.status=ko.observable(n.Status),r.userType=ko.observable(n.UserType),u=[],app.hasValue(n.Agrees)&&(u=n.Agrees.split(",")),r.agrees=ko.observableArray(u),r.isAgree=ko.computed(function(){return i.userId!=null&&jQuery.inArray(i.userId,r.agrees())>=0?!0:!1}),f=[],app.hasValue(n.Disagrees)&&(f=n.Disagrees.split(",")),r.disagrees=ko.observableArray(f),r.totalReplies=ko.observable(n.TotalReplies),r.viewReplyText=ko.computed(function(){return"Xem tất cả "+r.totalReplies()+" câu trả lời"})):(r.id=ko.observable(0),r.userId=ko.observable(0),r.userName=ko.observable(""),r.time=ko.observable(""),r.parent=ko.observable(null),r.male=ko.observable(!1),r.detail=ko.observable(""),r.status=ko.observable(0),r.agrees=ko.observableArray([]),r.disagrees=ko.observableArray([]),r.totalReplies=ko.observable(null),r.viewReplyText=ko.observable(""),r.userType=ko.observable(0));r.isAgree=ko.computed(function(){return i.userId!=null&&jQuery.inArray(i.userId,r.agrees())>=0?!0:!1});r.isDisagree=ko.computed(function(){return i.userId!=null&&jQuery.inArray(i.userId,r.disagrees())>=0?!0:!1});r.uimg=ko.computed(function(){var t="";return n.UserId>0&&(t='<img data-src="'+staticDomain+app.idImage("agents",0,n.UserId,"100x100","avatar")+'" class="img-circle img-sm lazy" alt="" src="'+staticDomain+'/media/shared/bg.gif" />'),t});r.childs=ko.observableArray([]);r.loadState=ko.observable(0);r.enableChild=ko.observable(!1);r.replyLateText=ko.computed(function(){return"Quản trị viên sẽ xử lý bình luận của "+("<strong>"+r.userName()+"<\/strong> trong vòng ít phút")});r.isNew=ko.observable(t)},s=function(t){var i=this;i.comments=ko.observableArray([]);i.activeComment=ko.observable();i.loading=ko.observable(!1);i.total=ko.observable(0);i.replyingComment=ko.observable(new Comment(null,!1));i.isAllow=function(){return app.hasValue(t.userId)?!0:(window.location.href=idDomain+"/auth/login?returnurl="+e.url+r,!1)};i.agree=function(n){i.isAllow()&&postData("/api/agreeComment",{id:n.id()},function(i){var r;i==1?(n.agrees.push(t.userId),r=n.disagrees(),r=jQuery.grep(r,function(n){return n!=t.userId}),n.disagrees(r)):i==-1&&(r=n.agrees(),r=jQuery.grep(r,function(n){return n!=t.userId}),n.agrees(r))})};i.disagree=function(n){i.isAllow()&&postData("/api/disagreeComment",{id:n.id()},function(i){var r;i==1?(n.disagrees.push(t.userId),r=n.agrees(),r=jQuery.grep(r,function(n){return n!=t.userId}),n.agrees(r)):i==-1&&(r=n.disagrees(),r=jQuery.grep(r,function(n){return n!=t.userId}),n.disagrees(r))})};i.hidechilds=function(n){n.enableChild(!1)};i.showchilds=function(t){t.childs().length==0?(t.loadState(1),loadData("/api/commentList",{parentId:t.id(),url:e.url,unlimited:!0},null,function(i){t.enableChild(!0);t.loadState(2);n(i.Many).each(function(){t.childs.push(new f(this,!1))});app.lazyLoader()})):t.enableChild(!0)};i.reply=function(t,e){if(i.isAllow()){t.parent()!=null?n(i.comments()).each(function(){this.id()==t.parent()&&i.replyingComment(this)}):i.replyingComment(t);n(r).find(".reply-form-render").html("");var o=n(e.target),s=n(o).closest(".media-body").find('.reply-form-render[forcomid="'+t.id()+'"]');u.drawComForm(s,"@"+t.userName()+": ",function(t){u.comFormEvents(t,i.replyingComment().id(),function(r){var u,e;n("#"+t).remove();i.replyingComment().loadState()==2&&(u=new f(r,!0),i.replyingComment().childs.push(u),setTimeout(function(){u.isNew(!1)},300));e=i.replyingComment().totalReplies();e++;i.replyingComment().totalReplies(e);i.replyingComment().childs().length==0&&i.showchilds(i.replyingComment());app.lazyLoader()});n("#"+t+" textarea").focusTextToEnd()});n(r).find(".com-form-top .btn-sent").css("display","none");t.totalReplies()>0&&t.childs().length==0&&i.showchilds(t)}};i.currentPage=1;i.loadData=function(t){loadData("/api/commentList",e,i.currentPage,function(r){i.total(r.Count);n(r.Many).each(function(){var t=new f(this,!1);n(r.Many).each(function(){this.ParentId==t.id()&&t.childs.push(new f(this,!1))});i.comments.push(t);app.lazyLoader()});t!=null&&t()})};i.init=function(){i.loading(!0);i.loadData(function(){i.loading(!1)});var t=n(r).find(".com-form-top").attr("id");u.comFormEvents(t,null,function(t){var u=new f(t,!0);i.comments.unshift(u);setTimeout(function(){u.isNew(!1)},300);n(r).find(".com-form-top textarea").val("")});n(r).find(".view-more-com").unbind().click(function(){var t=n(this);t.button("loading");i.currentPage++;i.loadData(function(){t.button("reset")})})};i.init()},h=function(){var u=app.newGuid(),t='<div class="comment-component"><div class="row"><div class="col-md-6"><h5 class="no-margin-bottom" data-bind="visible: loading() == false"><strong data-bind="text: total() + \' bình luận\'" ><\/strong><\/h5><\/div><\/div><div class="comment-form com-form-top" id="'+u+'"><div class="media"><div class="media-left">';t+=app.hasValue(i.userId)?'<img class="img-circle img-sm lazy" data-src="'+staticDomain+app.idImage("agents",0,i.userId,null,"avatar")+'" src="" />':'<img class="img-circle img-sm lazy" data-src="'+staticDomain+'/media/default/agents/default-user.png" src=""/> ';t+='<\/div><div class="media-body"><div class="com-box"><div class="arrow-inner"><\/div><div class="arrow-outer"><\/div><textarea class="form-control '+(app.hasValue(i.userId)?"":"pointer")+'" rows="2" placeholder="Mời bạn để lại bình luận"><\/textarea><\/div><div class="text-right"><button type="button" disabled="disabled" style="display: none" class="btn btn-sm btn-primary btn-sent  mt-10"  data-loading-text="<i class=\'icon-spinner10 spinner position-left\'><\/i> Đang xử lý">Bình luận<\/button><\/div><\/div><\/div><\/div><div class="com-list"><div class="loader" data-bind="visible: loading() == true"><i class="icon-spinner10 fa-spin"><\/i><\/div><ul class="media-list" data-bind="foreach: comments"><li class="media" data-bind="attr:{ comid: id() }, css: { new : isNew() == true }"><div class="media-left" data-bind="html : uimg"><\/div><div class="media-body"><div class="media-heading"><span class="text-bold name" data-bind="text: userName"><\/span><span class="media-annotation dotted" data-bind="visible: userType() == true"><label class="label label-primary">Quản trị viên<\/label><\/span><span class="media-annotation dotted" data-bind="text: time"><\/span><\/div><div class="detail" data-bind="html : detail"><\/div><ul class="list-inline list-inline-separate text-size-small"><li><a class="reply-btn" href="javascript:void(0)" data-bind="click: $root.reply" class="text-muted">Trả lời<\/a><\/li><li data-bind=""><a href="javascript:void(0)" data-bind="click: $root.agree" title="Thích" class="text-muted"><span class="text-info-600" data-bind="text: agrees().length"><\/span><i class="fa position-right" data-bind="css: { \'fa-thumbs-up\' : isAgree() == true, \'fa-thumbs-o-up\' : isAgree() == false }"><\/i><\/a><\/li><li data-bind=""><a href="javascript:void(0)" data-bind="click: $root.disagree" title="Không thích" class="text-muted"><span class="text-info-600" data-bind="text: disagrees().length"><\/span><i class="fa position-right" data-bind="css: { \'fa-thumbs-down\' : isDisagree() == true, \'fa-thumbs-o-down\' : isDisagree() == false }"><\/i><\/a><\/li><\/ul><div class="reply-form-render" data-bind="attr:{ forcomid: id() }"><\/div><button class="view-replies" data-bind="click: $root.showchilds, visible: enableChild() == false && totalReplies() > 0"><span class="" data-bind="text: viewReplyText"><\/span><i class="icon-arrow-down12"><\/i><i class="icon-spinner10 fa-spin" data-bind="visible: loadState() == 1"><\/i><\/button><button class="view-replies" data-bind="click: $root.hidechilds, visible: enableChild() == true"><span>Ẩn câu trả lời<\/span><i class="icon-arrow-up12"><\/i><\/button><div class="reply-content" data-bind="visible : childs().length > 0 && enableChild() == true"><!-- ko foreach: childs --><div class="media" data-bind="attr:{ comid: id() }, css: { new : isNew() == true }"><div class="media-left" data-bind="html : uimg"><\/div><div class="media-body"><div class="media-heading"><span class="text-bold name" data-bind="text: userName"><\/span><span class="media-annotation dotted" data-bind="visible: userType() == true"><label class="label label-primary">Quản trị viên<\/label><\/span><span class="media-annotation dotted" data-bind="text: time"><\/span><\/div><div class="detail" data-bind="html : detail"><\/div><ul class="list-inline list-inline-separate text-size-small"><li><a class="reply-btn" href="javascript:void(0)" data-bind="click: $root.reply" class="text-muted">Trả lời<\/a><\/li><li data-bind=""><a href="javascript:void(0)" data-bind="click: $root.agree" title="Thích" class="text-muted"><span class="text-info-600" data-bind="text: agrees().length"><\/span><i class="fa position-right" data-bind="css: { \'fa-thumbs-up\' : isAgree() == true, \'fa-thumbs-o-up\' : isAgree() == false }"><\/i><\/a><\/li><li data-bind=""><a href="javascript:void(0)" data-bind="click: $root.disagree" title="Không thích" class="text-muted"><span class="text-info-600" data-bind="text: disagrees().length"><\/span><i class="fa position-right" data-bind="css: { \'fa-thumbs-down\' : isDisagree() == true, \'fa-thumbs-o-down\' : isDisagree() == false }"><\/i><\/a><\/li><\/ul><div class="reply-form-render" data-bind="attr:{ forcomid: id() }"><\/div><\/div><\/div><!-- /ko --><\/div><\/div><\/li><\/ul><\/div><div class="row mb-15 mt-10" data-bind="visible: comments().length < total()"><div class="col-md-12" style="text-align: center"><button class="btn btn-default btn-sm btn-block view-more-com" data-loading-text="<i class=\'icon-spinner10 spinner position-left\'><\/i> Đang thực hiện ..." style="max-width: 300px; margin: auto">Xem thêm<\/button><\/div><\/div>';t+="<\/div>";n(r).append(t)},c=function(){h()};return c(),o=new s(i),ko.applyBindings(o,n(r)[0]),this}}(jQuery);ko.bindingHandlers.fadeVisible={init:function(n,t){var i=t();$(n).toggle(ko.unwrap(i))},update:function(n,t){var i=t();ko.unwrap(i)?$(n).fadeIn():$(n).fadeOut()}}