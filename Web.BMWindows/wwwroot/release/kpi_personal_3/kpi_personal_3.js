function initKpi(){console.log(perform);vm=new KpiPersonalViewModel;ko.applyBindings(vm,$("#applyBinding")[0]);$("body").css("overflow-x","hidden");InfoEvents()}var table="#render_table",atl=table+" .area-tl",atr=table+" .area-tr",abl=table+" .area-bl",abr=table+" .area-br",eecm="#edit_evaluation_criteria_modal",vm,defaultMucTieuThaiDoHanhVi="Đảm bảo không vi phạm các hành vi được nêu tại Phục lục Tiêu chí hành vi thái độ của Quy chế vận hành KPIs. Khi đánh giá kết quả, liệt kê tất cả hành vi được cộng,trừ điểm theo quy chế ở đây",detailEmpty={Id:0,ParentId:null,KpiPersonalId:0,KpiYearAllocationId:null,CustomAllocationId:null,Group:0,STT:"",DuLieuChungMinh:null,MucTieu:"",TrongSo:"",CongThucDo:null,PhuongPhapDo:"",NguonChungMinh:"",KpiEvaluationCriteriaId:null,EvaluationCriteriaStr:"",DonViTinh:"",KeHoach:"",X:"",Y:"",ThucHien:"",TyLeHoanThanh:"",TyLeTrongSo:"",KetQua_Text:"",KetQua_TrangThai:"",LyDoChinhSua:"",DinhKem_DK:"",DinhKem_KQ:"",Summary:!1,RowHeight:0,isDelete:0,KpiPersonalOrganizationId:null,DangKy_DinhKem:null,KetQua_DinhKem:null,Status:null},approvalDefault={Id:0,KpiCompanyId:0,Quy:0,TrangThaiHS:0,NgayCapNhatHS:null,DuyetDk:0,NgayDuyetDk:null,DuyetKq:0,NgayDuyetKq:null,LyDoKhongDongY:""},PerOrg=function(n){var t=this;t.Id=ko.observable(n.Id);t.TrongSo=ko.observable(n.TrongSo);t.NguoiDuyet=ko.observable(n.NguoiDuyet);t.OrganizationId=ko.observable(n.OrganizationId);t.OrganizationName=ko.observable("");t.TrongSo=ko.observable(n.TrongSo);t.KetQua=ko.observable(n.KetQua);t.total_TrongSo=ko.observable("");t.total_KetQua=ko.observable("");n.ObjOrganization!=null&&t.OrganizationName(n.ObjOrganization.Name);t.details=ko.observableArray([]);t.real=ko.computed(function(){var n=0,i=0,r;$(t.details()).each(function(){this.Status()!=1&&(n+=getGTPT(this.TyLeTrongSo()),app.hasValue(this.TrongSo())&&(i+=getGTPT(this.TrongSo())))});t.total_KetQua(Round(n)+"%");t.total_TrongSo(Round(i)+"%");r=n*getGTPT(t.TrongSo())/100;t.KetQua(Round(r)+"%")})},KpiDetail=function(n,t,i){var r=this,f,u;r.loaded=!1;r.guid=ko.observable(app.newGuid(10));n!=null?(n.DonViTinh==null&&(n.DonViTinh=""),r=$.extend(r,ko.mapping.fromJS(n))):(r=$.extend(r,ko.mapping.fromJS(detailEmpty)),r.STT(t));r.cdv=ko.observable(i);r.childs=ko.observableArray([]);r.formulaId=ko.observable(0);r.fDesc=ko.observable("");r.formula=ko.observable("");r.principles=ko.observableArray(principles);r.CongThucDoHtml=ko.observable("");r.KeHoachStr=ko.observable("");r.ThucHienStr=ko.observable("");r.KeHoach.subscribe(function(){var n=CheckKeHoachX(r.PhuongPhapDo(),r.KeHoach());r.PhuongPhapDo()!=5?r.KeHoachStr(app.formatPrice(n)):r.KeHoachStr(n);r.X(n)});r.enableNotAllocate=ko.computed(function(){return vm!=null?vm.status()==null&&vm.perform=="create"&&(r.Status()==0||r.Status()==2):!1});r.enableAllocate=ko.computed(function(){return vm!=null?r.KpiYearAllocationId()==null&&vm.status()==null&&vm.perform=="create"&&(r.Status()==null||r.Status()==0||r.Status()==2)&&r.Group()!=1:!1});r.enableKH=ko.computed(function(){return vm!=null?r.KpiEvaluationCriteriaId()!=null&&r.PhuongPhapDo()!=null&&!app.hasValue(r.KeHoach()):!1});r.enableCustomAllocation=ko.computed(function(){return vm!=null?r.KpiYearAllocationId()==null&&vm.status()==null&&vm.perform=="create"&&(r.Status()==0||r.Status()==2)&&r.Group()!=1:!1});r.empty=ko.observable(!1);f=CheckKeHoachX(r.PhuongPhapDo(),r.KeHoach());r.PhuongPhapDo()!=5?r.KeHoachStr(app.formatPrice(f)):r.KeHoachStr(f);r.PhuongPhapDo()<=5?r.formulaId(r.PhuongPhapDo()):r.PhuongPhapDo()<=9?r.formulaId(6):r.formulaId(10);r.TrongSo.subscribe(function(){var t=r.TrongSo(),n=CheckTyLe(r.TrongSo());t!=n?r.TrongSo(n):r.tinhKQ()});r.expanded=ko.observable(!0);r.isDelete=ko.observable(!1);r.ThucHien.subscribe(function(){var n="";r.PhuongPhapDo()==5?n=r.ThucHien():r.ThucHien()!=""&&(n=r.Group()==1?r.ThucHien():app.formatPrice(r.ThucHien()));r.ThucHienStr(n);r.tinhKQ()});r.TyLeHoanThanh.subscribe(function(){var i=r.TyLeHoanThanh(),n=CheckTyLe(r.TyLeHoanThanh()),t;i!=n?r.TyLeHoanThanh(n):(t=tinhTyLeTrongSo(r.TrongSo(),r.TyLeHoanThanh()),r.TyLeTrongSo(t))});r.tinhKQ=function(){if(r.TrongSo()=="0%")r.TyLeHoanThanh("0%"),r.TyLeTrongSo("0%"),r.KetQua_Text("Không đăng ký"),r.KetQua_TrangThai(0);else{r.Group()==1&&(r.PhuongPhapDo()==null&&r.PhuongPhapDo(3),app.hasValue(r.KeHoach())||r.KeHoach(100));var n=tinhTyLeHoanThanh(r.PhuongPhapDo(),r.KeHoach(),r.Y(),r.ThucHien()),t=tinhTyLeTrongSo(r.TrongSo(),n);r.TyLeHoanThanh(n);r.TyLeTrongSo(t);n=="100%"?(r.KetQua_Text("Đạt"),r.KetQua_TrangThai(1)):(r.KetQua_Text("Không đạt"),r.KetQua_TrangThai(2))}};r.real=ko.computed(function(){var n="";r.PhuongPhapDo()==5?n=r.ThucHien():r.ThucHien()!=""&&(n=r.Group()==1?r.ThucHien():app.formatPrice(r.ThucHien()));r.ThucHienStr(n)});r.loaded=!0;u=r.CongThucDo();u=app.replaceBrToNewLine(u);r.CongThucDo(u);r.CongThucDoHtml(u);r.mht=0;setTimeout(function(){(r.RowHeight()<80||r.RowHeight()==null)&&r.RowHeight(80);$(".kd_"+r.guid()+" td textarea").css("height",r.RowHeight()-1+"px");$(".kd_"+r.guid()+" td .resize-height").css("height",r.RowHeight()-1+"px");$(".kd_"+r.guid()+" > td").css("height",r.RowHeight()+"px");$(".file-attach").uniform({fileButtonClass:"action btn btn-default btn-xs text-slate",fileButtonHtml:'<i class="icon-file-plus"><\/i>'});$("#attach-dangky-"+r.guid()).change(function(){uploadDinhKem(this,function(n){n.length>0&&r.DangKy_DinhKem(n[0].path)})});$("#attach-ketqua-"+r.guid()).change(function(){uploadDinhKem(this,function(n){n.length>0&&r.KetQua_DinhKem(n[0].path)})})},200);r.isRequest=ko.observable(!0);r.modifyMucTieu=ko.observable(!1);r.modifyTrongSo=ko.observable(!1);r.modifyPhuongPhapDo=ko.observable(!1);r.modifyDuLieuChungMinh=ko.observable(!1);r.modifyDonViTinh=ko.observable(!1);r.modifyKeHoach=ko.observable(!1);r.modifyDinhKem=ko.observable(!1);r.modifyMaDongBo=ko.observable(!1)},DetailGroup=function(){var n=this;n.orgs=ko.observableArray([])},EvaluationCriteria=function(n,t){var i=this;i.Id=n.Id;i.NoiDung=n.NoiDung;i.TyLeCongTru=n.TyLeCongTru;i.TyLeCongTruStr=ko.computed(function(){var t=n.TyLeCongTru;return t>=0&&(t="+"+t),t+"%"});i.index=ko.observable(t);i.selected=ko.observable(!1)},EvaluationCriteriaGroup=function(n,t){var i=this;i.name=n.Name;i.id=n.Id;i.index=ko.observable(t);i.criterias=ko.observableArray([])},f=[],KpiPersonalViewModel=function(){var n=this;n.status=ko.observable(model.ModifyStatus);console.log(n.status());n.group1=ko.observableArray([]);n.tab=tab;n.perform=perform;n.authId=empId;n.createdBy=model.CreatedBy;n.ownerId=model.OwnerId;n.isBks=isBks;n.isAdmin=isAdmin;n.group2=ko.observableArray([]);n.G1_TrongSo=ko.observable("20%");n.G2_TrongSo=ko.observable("80%");n.G1_KetQua=ko.observable("");n.G2_KetQua=ko.observable("");n.TK_TrongSo=ko.observable("100%");n.TK_KetQua=ko.observable("");n.isSubmit=ko.observable(!1);n.activeDetail=ko.observable(new KpiDetail(null));n.formulas=ko.observableArray([]);n.subFormulas=ko.observableArray([]);n.loaded=ko.observable(!1);n.activeCell=ko.observable("");n.listDonViTinh=ko.observableArray(listDonViTinh);n.eCGroups=ko.observableArray([]);n.real=ko.computed(function(){var i=0,r=0,t=0;$(n.group1()).each(function(){this.isDelete()==!1&&(t+=getGTPT(this.TyLeTrongSo()))});i=t*getGTPT(n.G1_TrongSo())/100;n.G1_KetQua(Round(i)+"%");t=0;$(n.group2()).each(function(){var n=ko.toJS(this);t+=getGTPT(n.KetQua)});i=t*getGTPT(n.G2_TrongSo())/100;n.G2_KetQua(Round(i)+"%");r=getGTPT(n.G1_KetQua())+getGTPT(n.G2_KetQua());n.TK_KetQua(Round(r)+"%")});n.selectCriteria=function(n){var t=n.selected();n.selected(!t)};n.expendGroup=function(n){var t=n.expanded();n.expanded(!t);$(n.childs()).each(function(){this.expanded(!t)})};n.renderSubmitData=function(){var t=$(".select-year option:selected"),i={Id:model.Id,Year:t.attr("year"),Month:t.attr("month"),Type:model.Type,OwnerId:model.OwnerId,EmployeeId:model.EmployeeId,CreatedBy:model.CreatedBy,details:[],personalOrgs:[],OrganizationId:model.OrganizationId,JobPositionId:model.JobPositionId,G1_TrongSo:n.G1_TrongSo(),G1_KetQua:n.G1_KetQua(),G2_TrongSo:n.G2_TrongSo(),G2_KetQua:n.G2_KetQua(),TK_TrongSo:n.TK_TrongSo(),TK_KetQua:getGTPT(n.TK_KetQua()),AuthEmployeeId:empId},r=ko.toJS(n.group2());return $(r).each(function(){$(this.details).each(function(){this.childs=null;this.fDesc=null;this.CongThucDo="";this.__ko_mapping__=null});this.childs=null;this.fDesc=null;this.CongThucDo="";this.__ko_mapping__=null;i.personalOrgs.push(this)}),i};n.checkHSValid=function(n){var t=!0,i;return($(n.details).each(function(){var n=this;if(!n.Summary&&n.ParentId!=null&&!n.isDelete&&/^\d+(\.\d+)?%$/.test(n.TrongSo)==!1&&n.TrongSo!="")return t=!1,app.i65tify("warning","Giá trị trọng số không hợp lệ"),!1;switch(parseInt(n.MaPhuongPhapDo)){case 1:case 2:case 3:if(n.X=="")return app.notify("warning","Giá trị KPIs kế hoạch không hợp lệ"),t=!1,!1;break;case 4:case 5:case 7:case 8:case 9:case 11:case 12:case 13:if(n.X==""||n.Y=="")return app.notify("warning","Giá trị KPIs kế hoạch không hợp lệ"),t=!1,!1}}),t&&(i=0,$(n.personalOrgs).each(function(){var n=this,r=0;if($(n.details).each(function(){var n=this,u;if(n.Status!=1){if(u=parseInt(n.TrongSo.substr(0,n.TrongSo.length-1)),r+=u,i+=u,n.MucTieu==null||n.MucTieu=="")return app.notify("warning","Tên mục tiêu chưa đầy đủ"),t=!1,!1;if(/^\d+(\.\d+)?%$/.test(n.TrongSo)==!1&&n.TrongSo!="")return t=!1,app.notify("warning","Giá trị trọng số không hợp lệ."),!1;if(n.DuLieuChungMinh==null||n.DuLieuChungMinh==""||n.DonViTinh==null||n.DonViTinh=="")return app.notify("warning","Nội dung mục tiêu chưa đầy đủ"),t=!1,!1;if(n.PhuongPhapDo==null||n.PhuongPhapDo=="")return app.notify("warning","Phương pháp đo chưa hợp lệ."),t=!1,!1}}),!t)return!1;r!=100&&(app.notify("warning","Tổng trọng số trong bộ phận "+n.OrganizationName+" phải đủ 100%"),t=!1)}),!t))?!1:t};n.checkKQValid=function(n){var t=!0;return $(n.personalOrgs).each(function(){var n=this;$(n.details).each(function(){var n=this;if(!n.isDelete&&(n.ThucHien==null||n.ThucHien==""))return app.notify("warning","Giá trị thực hiện chưa đầy đủ"),t=!1,!1})}),t};n.post=function(n,t){app.postData(DOMAIN_API+"/kpi/requestModifyKpiPersonal",n,function(n){t(n)})};n.events=function(){$("#btn-save-hs").unbind().click(function(){var t=n.renderSubmitData(),i;t!=null&&(t.perform=model.Id>0?"updateHS":"create",i=$(this),i.button("loading"),n.post(t,function(){i.button("reset")}))});$("#btn-save-gui-hs").unbind().click(function(){var i,t,r;n.isSubmit(!0);i=$(this);t=n.renderSubmitData();t!=null&&(t.perform=model.Id>0?"updateHS":"create",t.buocduyet=1,t.sent=!0,r=n.checkHSValid(t),r&&(i.button("loading"),n.post(t,function(){i.button("reset");window.location.href="/kpi/personaledit?tab=tab2&id="+model.Id})))});$("#btn-duyet-dk").unbind().click(function(){confirmDuyet(DOMAIN_API+"/kpi/DuyetKpiPersonal",{id:model.Id,buocduyet:1,personalOrgId:$(this).attr("data-po"),capDuyet:$(this).attr("cap"),trangThai:2},function(){window.location.href="/kpi/personaledit?id="+model.Id})});$("#btn-khong-duyet-dk").unbind().click(function(){confirmKhongDuyet(DOMAIN_API+"/kpi/duyetKpiPersonal",{trangThai:3,capDuyet:$(this).attr("cap"),buocduyet:1,id:model.Id,personalOrgId:$(this).attr("data-po")},function(n){n&&(window.location.href="/kpi/personaledit?id="+model.Id)})});$("#btn-save-kq").unbind().on("click",function(){var t=n.renderSubmitData(),i;t.perform="updateKQ";t!=null&&(i=$(this),i.button("loading"),n.post(t,function(){i.button("reset")}))});$("#btn-save-gui-kq").unbind().on("click",function(){var i=$(this),t,r;n.isSubmit(!0);t=n.renderSubmitData();t!=null&&(t.perform="updateKQ",t.buocduyet=2,t.sent=!0,r=n.checkKQValid(t),r&&(i.button("loading"),n.post(t,function(){i.button("reset");window.location.href="/kpi/personaledit?tab=tab2&id="+model.Id})))});$("#btn-duyet-kq").unbind().click(function(){confirmDuyet(DOMAIN_API+"/kpi/DuyetKpiPersonal",{id:model.Id,buocduyet:2,capDuyet:$(this).attr("cap"),personalOrgId:$(this).attr("data-po"),trangThai:2},function(n){n&&(window.location.href="/kpi/personaledit?id="+model.Id)})});$("#btn-khong-duyet-kq").unbind().click(function(){confirmKhongDuyet(DOMAIN_API+"/kpi/duyetKpiPersonal",{trangThai:3,capDuyet:$(this).attr("cap"),personalOrgId:$(this).attr("data-po"),buocduyet:2,id:model.Id},function(n){n&&(window.location.href="/kpi/personaledit?id="+model.Id)})});$('#edit_muctieu_modal  input[name="X"]').unbind().change(function(){var n=$(this).val();console.log(n)})};n.selectCell=function(t,i){n.activeCell(t);$(i.currentTarget).find("textarea").focus()};n.initSelect2=function(){};n.addDetail=function(n){var i=1,t;$(n.details()).each(function(){this.isDelete()==!1&&i++});t=new KpiDetail(null,i,!0);t.Status(0);t.Group(2);n.details.push(t)};n.editPhuongPhapDo=function(t,i){n.activeCell("cell_ctd_"+t.guid());n.activeDetail(t);var r=$(i.currentTarget);r.button("loading");initPhuongPhapDoModal({PhuongPhapDo:t.PhuongPhapDo(),X:t.X(),Y:t.Y()},function(t){n.activeDetail().PhuongPhapDo(t.phuongPhapDo);n.activeDetail().CongThucDoHtml(t.forumla);n.activeDetail().X(t.X);n.activeDetail().Y(t.Y);n.activeDetail().KeHoach(t.X)},!0,function(){r.button("reset")})};n.editDetail=function(n){var t=n.Status();t!=2?n.Status(2):n.Status(null)};n.deleteDetail=function(n,t){n.Id()>0?n.Status()!=1?n.Status(1):n.Status(null):t.details.remove(n)};n.removeDinhKem=function(n,t){t==0?n.DangKy_DinhKem(""):n.KetQua_DinhKem("")};n.editEvaluationCriteria=function(t){n.activeDetail(t);$(eecm).modal("show")};n.resize=function(){};n.setAreaSize=function(){};n.resetIndex=function(t){$(n.group2()).each(function(){var i=this,n;this.Id()==t&&(n=0,$(i.details()).each(function(t,i){i.isDelete()==!1&&(i.STT(n+1),n++)}))})};n.hideCriteriaModal=function(){var r=0,i=[],u=[],f,t;$(n.eCGroups()).each(function(){$(this.criterias()).each(function(){this.selected()&&(r+=this.TyLeCongTru,i.push(this.NoiDung),u.push(this.Id))})});f=i.length>0?i.join("\r\n"):defaultMucTieuThaiDoHanhVi;t=100+r;t>100&&(t=100);t<0&&(t=0);console.log(t);$(n.group1()).each(function(){this.MucTieu(f);this.ThucHien(t+"%");this.EvaluationCriteriaStr(u.join(";"))});$(eecm).modal("hide")};n.init=function(){$(model.PersonalOrgs).each(function(){var t=new PerOrg(this,n.group2().length+1);n.group2.push(t)});app.loadData(DOMAIN_API+"/Kpi/KpiPersonalDetailList",{id:model.Id},null,function(t){t.length>0&&$(t).each(function(){var t=this;t.Group==2&&$(n.group2()).each(function(){if(t.KpiPersonalOrganizationId==this.Id()){var n=new KpiDetail(t,this.details().length+1,!0);n.Status(null);this.details.push(n)}})});n.loaded(!0)});n.loaded(!0);$(formulas).each(function(){this.ParentId==null?n.formulas.push(this):n.subFormulas.push(this)});$(listNhomThaiDoHanhViKPI).each(function(){var t=new EvaluationCriteriaGroup(this,n.eCGroups().length+1);$(attitudeEvaluationCriterias).each(function(){this.Type==t.id&&t.criterias.push(new EvaluationCriteria(this,t.criterias().length+1))});n.eCGroups.push(t)})};n.init()};ko.bindingHandlers.readonly={update:function(n,t){t()?$(n).attr("readonly","readonly"):($(n).removeAttr("readonly"),$(n).attr("disabled","disabled"))}}